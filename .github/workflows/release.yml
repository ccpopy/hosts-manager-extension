name: Build and Release Chrome Extension

on:
  push:
    tags:
      - "v*"
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: "18"

      - name: Install dependencies
        run: |
          # å®‰è£… crx3 å·¥å…·ç”¨äºŽæ‰“åŒ…æ‰©å±•
          npm install -g crx3

      - name: Create extension packages
        run: |
          # åˆ›å»ºå‘å¸ƒç›®å½•
          mkdir -p dist

          # åˆ›å»º ZIP åŒ…
          cd host
          zip -r ../dist/hosts-manager-${{ github.ref_name }}.zip . \
            -x "*.DS_Store" \
            -x ".git/*" \
            -x ".github/*"
          cd ..

          # åˆ›å»ºä¸å¸¦ç‰ˆæœ¬å·çš„ ZIP æ–‡ä»¶
          cp dist/hosts-manager-${{ github.ref_name }}.zip dist/hosts-manager.zip

      - name: Generate CRX file
        id: generate_crx
        run: |
          cd host

          # ä½¿ç”¨ crx3 ç”Ÿæˆ CRX æ–‡ä»¶
          # å¦‚æžœæœ‰ä¿å­˜çš„ç§é’¥ï¼Œå¯ä»¥ä½¿ç”¨ --key å‚æ•°
          if [ "${{ secrets.EXTENSION_PRIVATE_KEY }}" != "" ]; then
            # ä»Ž secrets ä¸­èŽ·å–ç§é’¥
            echo "${{ secrets.EXTENSION_PRIVATE_KEY }}" | base64 -d > temp.pem
            crx3 pack . --key temp.pem -o ../dist/hosts-manager-${{ github.ref_name }}.crx
            rm -f temp.pem
          else
            # ç”Ÿæˆæ–°çš„ç§é’¥
            crx3 pack . -o ../dist/hosts-manager-${{ github.ref_name }}.crx
          fi

          cd ..

          # åˆ›å»ºä¸å¸¦ç‰ˆæœ¬å·çš„ CRX æ–‡ä»¶
          cp dist/hosts-manager-${{ github.ref_name }}.crx dist/hosts-manager.crx

          # è¾“å‡ºæ–‡ä»¶ä¿¡æ¯
          echo "Generated files:"
          ls -la dist/

      - name: Create Release
        id: create_release
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ github.ref }}
          release_name: Release ${{ github.ref }}
          body: |
            ## Hosts Manager Chrome Extension ${{ github.ref_name }}

            ### ðŸ“¥ å®‰è£…æ–¹æ³•

            #### æ–¹æ³•ä¸€ï¼šä¸‹è½½ ZIP æ–‡ä»¶ï¼ˆæŽ¨èï¼‰
            1. ä¸‹è½½ `hosts-manager.zip` æ–‡ä»¶
            2. è§£åŽ‹åˆ°æœ¬åœ°æ–‡ä»¶å¤¹
            3. æ‰“å¼€ Chrome æ‰©å±•ç®¡ç†é¡µé¢ (`chrome://extensions/`)
            4. å¼€å¯å³ä¸Šè§’çš„"å¼€å‘è€…æ¨¡å¼"
            5. ç‚¹å‡»"åŠ è½½å·²è§£åŽ‹çš„æ‰©å±•ç¨‹åº"
            6. é€‰æ‹©è§£åŽ‹åŽçš„æ–‡ä»¶å¤¹

            #### æ–¹æ³•äºŒï¼šä½¿ç”¨ CRX æ–‡ä»¶
            1. ä¸‹è½½ `hosts-manager.crx` æ–‡ä»¶
            2. æ‰“å¼€ Chrome æ‰©å±•ç®¡ç†é¡µé¢ (`chrome://extensions/`)
            3. å°† CRX æ–‡ä»¶æ‹–æ”¾åˆ°æ‰©å±•ç®¡ç†é¡µé¢
            4. ç¡®è®¤å®‰è£…

            > âš ï¸ **æ³¨æ„**ï¼šChrome å¯èƒ½ä¼šé˜»æ­¢éž Chrome Web Store çš„ CRX æ–‡ä»¶å®‰è£…ã€‚å¦‚é‡åˆ°é—®é¢˜ï¼Œè¯·ä½¿ç”¨æ–¹æ³•ä¸€ã€‚

            ### ðŸ“ æ›´æ–°æ—¥å¿—

            è¯·æŸ¥çœ‹ [å®Œæ•´æ›´æ–°æ—¥å¿—](https://github.com/${{ github.repository }}/commits/${{ github.ref_name }})

            ### ðŸ”§ åŠŸèƒ½ç‰¹ç‚¹

            - åˆ†ç»„ç®¡ç† hosts è§„åˆ™
            - æ‰¹é‡å¯¼å…¥åŠŸèƒ½
            - Socket ä»£ç†æ”¯æŒ
            - çŽ°ä»£åŒ– UI ç•Œé¢

            ### ðŸ“„ æ–‡ä»¶è¯´æ˜Ž

            - `hosts-manager.zip` - æ‰©å±•æºæ–‡ä»¶ï¼ˆæŽ¨èï¼‰
            - `hosts-manager.crx` - æ‰“åŒ…çš„æ‰©å±•æ–‡ä»¶
            - `hosts-manager-${{ github.ref_name }}.zip` - å¸¦ç‰ˆæœ¬å·çš„æºæ–‡ä»¶
            - `hosts-manager-${{ github.ref_name }}.crx` - å¸¦ç‰ˆæœ¬å·çš„æ‰©å±•æ–‡ä»¶
          draft: false
          prerelease: false

      - name: Upload ZIP file
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ steps.create_release.outputs.upload_url }}
          asset_path: ./dist/hosts-manager.zip
          asset_name: hosts-manager.zip
          asset_content_type: application/zip

      - name: Upload versioned ZIP file
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ steps.create_release.outputs.upload_url }}
          asset_path: ./dist/hosts-manager-${{ github.ref_name }}.zip
          asset_name: hosts-manager-${{ github.ref_name }}.zip
          asset_content_type: application/zip

      - name: Upload CRX file
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ steps.create_release.outputs.upload_url }}
          asset_path: ./dist/hosts-manager.crx
          asset_name: hosts-manager.crx
          asset_content_type: application/x-chrome-extension

      - name: Upload versioned CRX file
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ steps.create_release.outputs.upload_url }}
          asset_path: ./dist/hosts-manager-${{ github.ref_name }}.crx
          asset_name: hosts-manager-${{ github.ref_name }}.crx
          asset_content_type: application/x-chrome-extension

      - name: Generate checksum
        run: |
          cd dist
          sha256sum *.zip *.crx > checksums.txt
          cd ..

      - name: Upload checksums
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ steps.create_release.outputs.upload_url }}
          asset_path: ./dist/checksums.txt
          asset_name: checksums.txt
          asset_content_type: text/plain
