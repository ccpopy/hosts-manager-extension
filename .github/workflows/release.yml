name: Build and Release Chrome Extension

on:
  push:
    tags:
      - "v*"
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Create extension package
        run: |
          # åˆ›å»ºå‘å¸ƒç›®å½•
          mkdir -p dist

          # è¿›å…¥ host ç›®å½•
          cd host

          # åˆ›å»ºæ‰©å±•çš„ zip åŒ…
          zip -r ../dist/hosts-manager-${{ github.ref_name }}.zip . \
            -x "*.DS_Store" \
            -x ".git/*" \
            -x ".github/*"

          # è¿”å›æ ¹ç›®å½•
          cd ..

          # ä¹Ÿåˆ›å»ºä¸€ä¸ªä¸å¸¦ç‰ˆæœ¬å·çš„ zip æ–‡ä»¶
          cp dist/hosts-manager-${{ github.ref_name }}.zip dist/hosts-manager.zip

      - name: Create Release
        id: create_release
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ github.ref }}
          release_name: Release ${{ github.ref }}
          body: |
            ## Hosts Manager Chrome Extension ${{ github.ref_name }}

            ### ğŸ“¥ å®‰è£…æ–¹æ³•

            1. ä¸‹è½½ `hosts-manager.zip` æ–‡ä»¶
            2. è§£å‹åˆ°æœ¬åœ°æ–‡ä»¶å¤¹
            3. æ‰“å¼€ Chrome æ‰©å±•ç®¡ç†é¡µé¢ (`chrome://extensions/`)
            4. å¼€å¯å³ä¸Šè§’çš„"å¼€å‘è€…æ¨¡å¼"
            5. ç‚¹å‡»"åŠ è½½å·²è§£å‹çš„æ‰©å±•ç¨‹åº"
            6. é€‰æ‹©è§£å‹åçš„æ–‡ä»¶å¤¹

            ### ğŸ“ æ›´æ–°æ—¥å¿—

            è¯·æŸ¥çœ‹ [å®Œæ•´æ›´æ–°æ—¥å¿—](https://github.com/${{ github.repository }}/commits/${{ github.ref_name }})

            ### ğŸ”§ åŠŸèƒ½ç‰¹ç‚¹

            - åˆ†ç»„ç®¡ç† hosts è§„åˆ™
            - æ‰¹é‡å¯¼å…¥åŠŸèƒ½
            - Socket ä»£ç†æ”¯æŒ
            - ç°ä»£åŒ– UI ç•Œé¢
          draft: false
          prerelease: false

      - name: Upload Release Asset
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ steps.create_release.outputs.upload_url }}
          asset_path: ./dist/hosts-manager.zip
          asset_name: hosts-manager.zip
          asset_content_type: application/zip

      - name: Upload Versioned Release Asset
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ steps.create_release.outputs.upload_url }}
          asset_path: ./dist/hosts-manager-${{ github.ref_name }}.zip
          asset_name: hosts-manager-${{ github.ref_name }}.zip
          asset_content_type: application/zip
